{
    "collab_server" : "",
    "contents" : "setwd(\"/Users/shaunratcliff/Dropbox/Academia/Teaching/ACSPRI/Summer 2018/Data/Public opinion - Australia\")\nsurvey.data <- read.csv(\"survey.data_messed_up.csv\")\n#names(survey.data)\n\nlibrary(car)\n\n#Education \n#prop.table(table(survey.data$Education_all, survey.data$Year) ,2)\n\nsurvey.data$Education_all <- recode(survey.data$Education_all, \n                                  \"'Did not finish highschool' = 'Some schooling';  \n                                    'Completed HS' = 'High school'\")\n\n# Vote \n\n#prop.table(table(survey.data$Vote_allparties, survey.data$Year),2)\n\nsurvey.data$Vote_allparties <- recode(survey.data$Vote_allparties, \n                                      \"'ALP' = 'Labor';\n                                      c('Liberals and Country Party', 'LNP') = 'Coalition';\n                                      c('Call to Au', 'Democrats', \n                                      'DLP', 'Grey Power', 'One Nation') = 'Other'\")\n\n\nsurvey.data$vote.major <- as.numeric(as.character(recode(survey.data$Vote_allparties,\n                                                         \"'Coalition' = 1;\n                                                         'Labor' = 0;\n                                                         c('Other', 'Greens') = NA\")))\n\n#prop.table(table(survey.data$vote.major, survey.data$Year),2)\n\n\n#Birthplace\n\n#prop.table(table(survey.data$Birthplace, survey.data$Year),2)\n\nsurvey.data$Birthplace <- recode(survey.data$Birthplace, \n                                 \"'Overseas' = 'Other'\")\n\n#Income \n\n\nsurvey.data$z.income <- scale(survey.data$income_percentile,\n                              scale = (sd(survey.data$income_percentile, na.rm=TRUE)*2))\n\n#age \n\nsurvey.data$z.age <- scale(survey.data$Age_year,\n                           scale = (sd(survey.data$Age_year, na.rm=TRUE)*2))\n\n\n#our dependent variable\n\ntable(survey.data$Immigrants_jobs)\n\n#fitting the model \n\nlibrary(arm)\nimmi.model.1 <- lm(Immigrants_jobs ~ z.income, data = survey.data)\ndisplay(immi.model.1)\n\nimmi.model.2 <- lm(Immigrants_jobs ~ z.income + z.age + Birthplace + Education_all + \n                     Urban, data = survey.data)\ndisplay(immi.model.2)\n\ncoef.fit.immi.job <- data.frame(coef(immi.model.2))\nse.fit.immi.job <- data.frame(se.coef(immi.model.2))\n\ncoef.fit.immi.job$one.se.upper <- coef.fit.immi.job[,1] + se.fit.immi.job[,1]\ncoef.fit.immi.job$one.se.lower <- coef.fit.immi.job[,1] - se.fit.immi.job[,1]\ncoef.fit.immi.job$two.se.upper <- coef.fit.immi.job[,1] + se.fit.immi.job[,1] *2\ncoef.fit.immi.job$two.se.lower <- coef.fit.immi.job[,1] - se.fit.immi.job[,1] *2\n\ncoef.fit.immi.job$vars <- as.factor(variable.names(immi.model.2))\n\nlevels(coef.fit.immi.job$vars) <- c(\"Intercept\", \"Birthplace - Other\", \n                                     \"Education - Some schooling\", \n                                    \"Education - Some tertiary\",  \n                                    \"Education - University\", \"Urban resident\", \"Age\",\n                                    \"Household income\")\n\n\ncoef.fit.immi.job$vars <- factor(coef.fit.immi.job$vars, \n                                 levels=c(\"Birthplace - Other\", \n                                          \"Education - Some schooling\",\n                                          \"Education - Some tertiary\", \n                                          \"Education - University\", \n                                          \"Urban resident\", \"Age\", \n                                          \"Household income\", \"Intercept\"))\n\n\nlibrary(ggplot2)\n\nplot.1 <- ggplot(coef.fit.immi.job, aes(x = coef.immi.model.2., y = vars)) +\n  geom_point(alpha=1, colour=\"black\", size=2.3) +   \n  geom_errorbarh(aes(xmin=one.se.lower,xmax=one.se.upper), height=0,size=.65) +\n  geom_errorbarh(aes(xmin=two.se.lower,xmax=two.se.upper), height=0,size=.25) +\n  geom_vline(xintercept=0, colour=\"black\", size = .5) +\n  labs(x = \"Coefficient values\", y = \"Regression coefficients\",\n       caption = \"Error bars are one and two standard errors\") + \n  theme_bw() +\n  theme(panel.border = element_blank(), \n        panel.grid.major.x = element_blank(), \n        panel.grid.major.y = element_line(colour=\"dark grey\", size=0.25), \n        panel.grid.minor = element_blank(), \n        legend.position=\"none\", \n        title = element_text(size=13, face=\"bold\"), \n        strip.background = element_blank(), \n        axis.title.x = element_text(size=12, face=\"bold\", vjust=-.75), \n        axis.title.y = element_text(size=12, face=\"bold\", vjust=1.5), \n        axis.text.x = element_text(size=10, vjust=-.25), \n        axis.text.y = element_text(size=8.5), \n        axis.ticks.y=element_blank())\n\n\npdf(file=\"./ plot.1.pdf\", width=5, height=5)\nprint(plot.1) \t\naux <- dev.off() \t\t#closes off the command\n\n\n\n### \n\nincome.slope <- data.frame(estimate = (coef(immi.model.2)[1] + \n                             coef(immi.model.2)[2] * c(-.5, 0, .5)))\n\nincome.slope$income.quintiles <- (c(-.5, 0, .5) * \n                                    attr(survey.data$z.income, \"scaled:scale\")) +\n                                    attr(survey.data$z.income, \"scaled:center\")\n\nsurvey.data$income.quintiles <- cut(survey.data$income_percentile, \n                                    5, labels = c(10,30,50,70,90)) \n\nlibrary(plyr)\nincome.average <- na.omit(ddply(survey.data, .(income.quintiles), summarize, \n                                estimate = mean(Immigrants_jobs, na.rm=TRUE)))\n\nincome.average$income.quintiles <- as.numeric(as.character(\n  income.average$income.quintiles))\n\nggplot(income.average, aes(income.quintiles, estimate)) +\n  geom_point(alpha=1, size=4, shape=1) +\n  geom_smooth(data = income.slope, \n              method = 'lm', \n              size=1, \n              colour=\"black\", \n              fullrange = TRUE) + \n  geom_smooth(method = 'lm', \n              size=1, \n              colour=\"red\", \n              fullrange = TRUE) + \n  scale_x_continuous(expand=c(0,0), \n                     breaks=c(25,50,75), limits=c(0,100)) +\n  scale_y_continuous(expand=c(0,0), \n                     minor_breaks=c(0.0001), breaks=c(-1,0,1), limits=c(-2,2))\n\n\n###Interactions\n\n\nimmi.model.3 <- lm(Immigrants_jobs ~ z.income + z.age + Birthplace + Education_all + \n                     Urban + z.income*Education_all, \n                   data = survey.data)\ndisplay(immi.model.3)\n\n\nincome.edu.slope <- data.frame(some.school = c(coef(immi.model.3)[1] +  \n                                                 (coef(immi.model.3)[2] * c(-.5,0,.5)) +\n                                                 coef(immi.model.3)[5] + \n                                                 (coef(immi.model.3)[9] * c(-.5,0,.5))),\n                               \n                               high.school = c(coef(immi.model.3)[1] +\n                                                 (coef(immi.model.3)[2] * c(-.5,0,.5))), \n                               \n                               some.tertiary = c(coef(immi.model.3)[1] + \n                                                   (coef(immi.model.3)[2] * c(-.5,0,.5)) +\n                                                   coef(immi.model.3)[6] + \n                                                   (coef(immi.model.3)[10] * \n                                                      c(-.5,0,.5))),\n                               \n                               university = c(coef(immi.model.3)[1] + \n                                                (coef(immi.model.3)[2] * c(-.5,0,.5)) +\n                                                coef(immi.model.3)[7] + \n                                                (coef(immi.model.3)[11] * c(-.5,0,.5))))\n\n\nlibrary(reshape2)\n\nincome.edu.slope <- melt(income.edu.slope)\nnames(income.edu.slope) <- c(\"Education_all\", \"Immigrants_jobs\")\nlevels(income.edu.slope$Education_all) <- c(\"Some schooling\", \n                                        \"High school\",\n                                        \"Some tertiary\",\n                                        \"University\")\nincome.edu.slope$income.quintiles <- (c(-.5, 0, .5) * \n                                    attr(survey.data$z.income, \"scaled:scale\")) +\n  attr(survey.data$z.income, \"scaled:center\")\n\n\nincome.average <- na.omit(ddply(survey.data, .(Education_all, income.quintiles), summarize, \n                                Immigrants_jobs = mean(Immigrants_jobs, na.rm=TRUE)))\n\nincome.average$income.quintiles <- as.numeric(as.character(\n  income.average$income.quintiles))\n\n\nggplot(income.average, aes(income.quintiles, Immigrants_jobs)) +\n  geom_point(alpha=1, size=4, shape=1) +\n  geom_smooth(data = income.edu.slope, \n              method = 'lm', \n              size=1, \n              colour=\"black\", \n              fullrange = TRUE) + \n  geom_smooth(method = 'lm', \n              size=1, \n              colour=\"red\", \n              se=FALSE,\n              fullrange = TRUE) + \n  scale_x_continuous(expand=c(0,0), \n                     breaks=c(25,50,75), limits=c(0,100)) +\n  scale_y_continuous(expand=c(0,0), \n                     minor_breaks=c(0.0001), breaks=c(-1,0,1), limits=c(-2,2)) +\n  facet_wrap(~ Education_all)\n\n\n###Logistic regression\n\ntable(survey.data$vote.major)\n\nfit.vote.major.1 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n    family=binomial(link=logit), data=survey.data)\ndisplay(fit.vote.major.1)\n\n\ninvlogit(coef(fit.vote.major.1)[1] + coef(fit.vote.major.1)[2] * c(-.5,0,.5))\n\n\n### fit seperate models by year \n\nfit.vote.major.1993 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                        family=binomial(link=logit), data=survey.data,\n                        subset=Year==1993)\ndisplay(fit.vote.major.1993)\n\n\nfit.vote.major.1996 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                           family = binomial(link=\"logit\"), subset=Year==1996, data = survey.data)\n#display(fit.vote.major.1996)\n\nfit.vote.major.1998 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                           family = binomial(link=\"logit\"), subset=Year==1998, data = survey.data)\n#display(fit.vote.major.1998)\n\nfit.vote.major.2001 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                           family = binomial(link=\"logit\"), subset=Year==2001, data = survey.data)\n#display(fit.vote.major.2001)\n\nfit.vote.major.2004 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                           family = binomial(link=\"logit\"), subset=Year==2004, data = survey.data)\n#display(fit.vote.major.2004)\n\nfit.vote.major.2007 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                           family = binomial(link=\"logit\"), subset=Year==2007, data = survey.data)\n#display(fit.vote.major.2007)\n\nfit.vote.major.2010 <- glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                           family = binomial(link=\"logit\"), subset=Year==2010, data = survey.data)\n#display(fit.vote.major.2010)\n#fit to 1996, 1998, 2001, 2004, 2007, 2010\n\nfit.vote.major.coefs <- data.frame(rbind(\nsummary(fit.vote.major.1993)$coefficients[,1],\nsummary(fit.vote.major.1996)$coefficients[,1],\nsummary(fit.vote.major.1998)$coefficients[,1],\nsummary(fit.vote.major.2001)$coefficients[,1],\nsummary(fit.vote.major.2004)$coefficients[,1],\nsummary(fit.vote.major.2007)$coefficients[,1],\nsummary(fit.vote.major.2010)$coefficients[,1]))\n\nfit.vote.major.coefs$year <- c(1993,1996,1998,2001,2004,2007,2010)\n\nfit.vote.major.coefs <- melt(fit.vote.major.coefs, id.vars = \"year\")\n\nse.fit.vote.major.coefs <- data.frame(rbind(\n  summary(fit.vote.major.1993)$coefficients[,2],\n  summary(fit.vote.major.1996)$coefficients[,2],\n  summary(fit.vote.major.1998)$coefficients[,2],\n  summary(fit.vote.major.2001)$coefficients[,2],\n  summary(fit.vote.major.2004)$coefficients[,2],\n  summary(fit.vote.major.2007)$coefficients[,2],\n  summary(fit.vote.major.2010)$coefficients[,2]))\n\nfit.vote.major.coefs$se <- melt(se.fit.vote.major.coefs)[,2]\n\n\nfit.vote.major.coefs$upper.se <- fit.vote.major.coefs$value + fit.vote.major.coefs$se \nfit.vote.major.coefs$lower.se <- fit.vote.major.coefs$value - fit.vote.major.coefs$se\n\nlevels(fit.vote.major.coefs$variable) <- c(\"Intercept\", \"Household income\",                   \n                                           \"Male\", \"Ed = some school\",\n                                           \"Ed = some tertiary\",  \"Ed = university\",    \n                                           \"Born overseas\")\nlibrary(ggplot2)\nggplot(fit.vote.major.coefs, aes(x = year, y = value)) +\n  geom_point() + \n  geom_errorbar(aes(ymin = lower.se, ymax=upper.se), width=0) +\n  geom_hline(yintercept = 0) +\n  scale_x_continuous(breaks=c(1995,2005)) + \n  scale_y_continuous(breaks=c(-.5, 0, .5)) +\n  theme_bw() +\n  theme(panel.grid = element_blank()) +\n  facet_wrap(~ variable, nrow=2)\n\n\n###predicting outcomes \n\n#install.packages(\"pscl\")\nlibrary(pscl)\n\nfit.vote.major.hit <- data.frame(rbind(hitmiss(fit.vote.major.1993)[1], \n                 hitmiss(fit.vote.major.1996)[1], \n                 hitmiss(fit.vote.major.1998)[1],\n                 hitmiss(fit.vote.major.2001)[1], \n                 hitmiss(fit.vote.major.2004)[1],\n                 hitmiss(fit.vote.major.2007)[1],\n                 hitmiss(fit.vote.major.2010)[1]))\n\nnames(fit.vote.major.hit) <- \"predicted\"\n\nfit.vote.major.hit$null <- c(50.12, 58.72, 51.88, 55.37, 57.83, 51.1, 50.99)\nfit.vote.major.hit$pred.minus.null <- fit.vote.major.hit$predicted - fit.vote.major.hit$null\nfit.vote.major.hit <- fit.vote.major.hit[c(\"predicted\", \"pred.minus.null\")]\nfit.vote.major.hit$year <- c(1993,1996,1998,2001,2004,2007,2010)\nfit.vote.major.hit <- melt(fit.vote.major.hit, id.vars=\"year\")\nlevels(fit.vote.major.hit$variable) <- c(\"Correctly predicted\", \n                                         \"Compared to null model\")\nfit.vote.major.hit$value <- fit.vote.major.hit$value / 100\n\n\n\nggplot(fit.vote.major.hit, aes(year, value)) + \n  geom_point(alpha=1, colour=\"black\", size=8) +   \n  labs(x = \"Year\") +\n  scale_x_continuous(breaks=c(1995, 2005), limits=c(1990,2010)) +\n  scale_y_continuous(minor_breaks=c(0.0001), limits=c(0,1), labels=percent) +\n  theme_bw() +\n  theme(panel.grid.major = element_blank(), \n        panel.grid.minor.x = element_blank(),\n        panel.grid.minor.y = element_line(colour=\"grey\", size=0.25), \n        legend.position=\"none\", \n        strip.text.x = element_text(size=11, vjust=.5), \n        strip.background = element_blank(), \n        axis.title.x = element_text(size=14, vjust=-.75), \n        axis.title.y = element_blank(), \n        axis.text.x = element_text(size=10, vjust=-.25), \n        axis.text.y = element_text(size=10, hjust=1)) +\n  facet_wrap( ~ variable, nrow=1)\n\n\n\n###predicting probabilities\n\nincome.slope.1993 <- data.frame(invlogit(summary(fit.vote.major.1993)$coefficients[1,1] + \n           summary(fit.vote.major.1993)$coefficients[2,1] * c(-.5, 0, .5)))\nnames(income.slope.1993) <- \"vote.major\"\nincome.slope.1993$Year <- \"1993\"\n\n\nincome.slope.1996 <- data.frame(invlogit(summary(fit.vote.major.1996)$coefficients[1,1] + (summary(fit.vote.major.1996)$coefficients[2,1] *  c(-.5,0,.5))))\nnames(income.slope.1996)[1] <- \"vote.major\"\nincome.slope.1996$Year <- \"1996\" \n\nincome.slope.1998 <- data.frame(invlogit(summary(fit.vote.major.1998)$coefficients[1,1] + (summary(fit.vote.major.1998)$coefficients[2,1] *  c(-.5,0,.5))))\nnames(income.slope.1998)[1] <- \"vote.major\"\nincome.slope.1998$Year <- \"1998\" \n\nincome.slope.2001 <- data.frame(invlogit(summary(fit.vote.major.2001)$coefficients[1,1] + (summary(fit.vote.major.2001)$coefficients[2,1] *  c(-.5,0,.5))))\nnames(income.slope.2001)[1] <- \"vote.major\"\nincome.slope.2001$Year <- \"2001\" \n\nincome.slope.2004 <- data.frame(invlogit(summary(fit.vote.major.2004)$coefficients[1,1] + (summary(fit.vote.major.2004)$coefficients[2,1] *  c(-.5,0,.5))))\nnames(income.slope.2004)[1] <- \"vote.major\"\nincome.slope.2004$Year <- \"2004\" \n\nincome.slope.2007 <- data.frame(invlogit(summary(fit.vote.major.2007)$coefficients[1,1] + (summary(fit.vote.major.2007)$coefficients[2,1] *  c(-.5,0,.5))))\nnames(income.slope.2007)[1] <- \"vote.major\"\nincome.slope.2007$Year <- \"2007\" \n\nincome.slope.2010 <- data.frame(invlogit(summary(fit.vote.major.2010)$coefficients[1,1] + \n                                           (summary(fit.vote.major.2010)$coefficients[2,1] *  \n                                              c(-.5,0,.5))))\nnames(income.slope.2010)[1] <- \"vote.major\"\nincome.slope.2010$Year <- \"2010\" \n\nincome.slope <-  rbind(income.slope.1993, income.slope.1996, income.slope.1998, \n                       income.slope.2001, income.slope.2004, income.slope.2007, \n                       income.slope.2010)\n\nincome.slope$income.quintiles <- ((c(-.5,0,.5) * 2) * \n                                    sd(survey.data$income_percentile, na.rm=TRUE)) + \n                                    mean(survey.data$income_percentile, na.rm=TRUE)\n\nincome.fit.vote.major.average <- na.omit(ddply(survey.data, .(income.quintiles, Year), \n                                               summarise,\n                                               vote.major = mean(vote.major, na.rm=TRUE)))\n\n\nincome.fit.vote.major.n <- na.omit(ddply(survey.data, .(income.quintiles, Year), \n                                               summarise,\n                                               n = length(vote.major)))\n\nlibrary(dplyr)\nincome.fit.vote.major.average <- left_join(income.fit.vote.major.average, income.fit.vote.major.n)\n\nincome.fit.vote.major.average$income.quintiles <- as.numeric(as.character(\n  income.fit.vote.major.average$income.quintiles))\n\n\nincome.fit.vote.major.average$Year <- ifelse(income.fit.vote.major.average$Year == \"1967\",NA, \n                                             income.fit.vote.major.average$Year)\n\n\n\nggplot(subset(income.fit.vote.major.average, !is.na(Year)), aes(income.quintiles, vote.major)) +\n         geom_point() + \n        geom_smooth(data = income.slope, \n                    method=\"lm\", \n                    se=FALSE) +\n      facet_wrap(~ Year)\n    \n\n###For loops\n\nsurvey.data$year.order <- as.numeric(as.factor(survey.data$Year))\ntable(survey.data$year.order, survey.data$Year)\n\ncoef.vote.model.year <- list()\nse.coef.vote.model.year <- list()\n\nfor(i in 6:12){\n  \n  model.data <- data.frame(subset(survey.data, year.order == i))\n    \n  coef.vote.model.year[[i]] <- data.frame(summary(glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                                  family = binomial(link=\"logit\"), data = model.data))$coefficients[,1])\n  \n  se.coef.vote.model.year[[i]] <- data.frame(summary(glm(vote.major ~ z.income + Gender + Education_all + Birthplace, \n                                   family = binomial(link=\"logit\"), data = model.data))$coefficients[,2])\n\n}\n\n\nvote.model.year.output <- data.frame(coef = matrix(unlist(coef.vote.model.year), byrow=TRUE))\n\nvote.model.year.output$se.upper <- vote.model.year.output[,1] + \n                                 data.frame(matrix(unlist(se.coef.vote.model.year), byrow=TRUE))\nvote.model.year.output$se.lower <- vote.model.year.output[,1] - \n                                    data.frame(matrix(unlist(se.coef.vote.model.year), byrow=TRUE))\nvote.model.year.output$vars <-   variable.names(glm(vote.major ~ z.income  + Gender + Education_all + Birthplace,\n                                                    family=binomial(link=\"logit\"),  data=model.data))\n\nvote.model.year.output$Year <- c(rep(1993,7),rep(1996,7),rep(1998,7),rep(2001,7),\n                                 rep(2004,7),rep(2007,7),rep(2010,7))\n\n\n###looping predicting probabilities \n\nincome.vals <- c(-.5, 0, .5)\nincome.slope.year <- data.frame(matrix(nrow=3, ncol=7))\n\nfor(i in 6:12){\n  for(j in 1:3){\nincome.slope.year[j,i] <- invlogit(coef.vote.model.year[[i]][1,] + \n  coef.vote.model.year[[i]][2,] * income.vals[j]) \n  }\n}\n\nnames(income.slope.year) <- levels(as.factor(survey.data$Year))\nincome.slope.year <- melt(income.slope.year)\nincome.slope.year$income.quintiles <- (c(-.5, 0, .5) * \n                                    attr(survey.data$z.income, \"scaled:scale\")) +\n                                    attr(survey.data$z.income, \"scaled:center\")\n\nincome.slope.year[,c(6:8)]\n\nlibrary(dplyr)\nincome.slope.year2 <- income.slope.year %>% select(variable, value, income.quintiles)\n\n\n### using simulations to estimate probability\n\nfit.vote.major.1993 <- glm(vote.major ~ Union_Power + z.income + Gender + Education_all + Birthplace, \n                           family=binomial(link=logit), data=survey.data,\n                           subset=Year==1993)\ndisplay(fit.vote.major.1993)\n",
    "created" : 1516141030490.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1740468695",
    "id" : "E0E0B67E",
    "lastKnownWriteTime" : 1516313827,
    "last_content_update" : 1516313827739,
    "path" : "~/Dropbox/Academia/Teaching/ACSPRI/Summer 2018/Data/Public opinion - Australia/public opinion analysis.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}